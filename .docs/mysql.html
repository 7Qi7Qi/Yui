<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8">  <meta name="built-on" content="2023-11-28T23:26:37.7566979"><meta name="build-number" content="${buildNumber}">       <title>MySQL | Yui</title><script id="virtual-toc-data" type="application/json">[{"id":"a261493d_132","level":0,"title":"隔离界别","anchor":"#a261493d_132"},{"id":"a261493d_144","level":0,"title":"索引","anchor":"#a261493d_144"},{"id":"a261493d_158","level":0,"title":"语句","anchor":"#a261493d_158"},{"id":"a261493d_166","level":0,"title":"案例","anchor":"#a261493d_166"},{"id":"a261493d_227","level":0,"title":"函数","anchor":"#a261493d_227"},{"id":"a261493d_228","level":0,"title":"字符串","anchor":"#a261493d_228"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="MySQL | Yui"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="Yui Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="mysql.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="MySQL | Yui"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "mysql.html#webpage", "url": "mysql.html", "name": "MySQL | Yui", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "Yui Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="MySQL" data-main-title="MySQL" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="sql"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Yui  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="MySQL"  id="MySQL.md"  >MySQL</h1>  <section class="chapter"><h2 id="a261493d_132" data-toc="a261493d_132">隔离界别</h2><ol class="list _decimal" id="a261493d_133"  type="1"  ><li class="list__item" id="a261493d_134"><p>查看指令： <code class="code" id="a261493d_135">show variables like 'transaction_isolation'</code></p><ol class="list _decimal" id="a261493d_136"  type="1"  ><li class="list__item" id="a261493d_137"><p>默认是 可以重复读 <code class="code" id="a261493d_138">Repeatable-Read</code></p></li><li class="list__item" id="a261493d_139"><p>推荐使用 读已提交 <code class="code" id="a261493d_140">Read Committed</code></p></li></ol></li><li class="list__item" id="a261493d_141"></li></ol><aside class="prompt" data-type="tip" data-title="" id="a261493d_142"><p id="a261493d_143">默认可重复读原因: 那Mysql在5.0这个版本以前，binlog只支持STATEMENT这种格式！ 而这种格式在读已提交(Read Committed)这个隔离级别下主从复制是有bug的 因此Mysql将可重复读(Repeatable Read)作为默认的隔离级别！</p></aside></section><section class="chapter"><h2 id="a261493d_144" data-toc="a261493d_144">索引</h2><section class="chapter"><h3 id="a261493d_145" data-toc="a261493d_145">索引失效</h3><ol class="list _decimal" id="a261493d_146"  type="1"  ><li class="list__item" id="a261493d_147"><p>当使用左或左右模糊匹配时，也就是 <code class="code" id="a261493d_148">like %xx</code> 或者 <code class="code" id="a261493d_149">like %xx%</code>。</p></li><li class="list__item" id="a261493d_150"><p>查询条件中对索引列使用函数。</p></li><li class="list__item" id="a261493d_151"><p>查询条件中对索引列使用表达式计算</p></li><li class="list__item" id="a261493d_152"><p>MySQL在遇到字符串和数字比较时，会自动把字符串转为数字，然后再比较。 </p><ol class="list _decimal" id="a261493d_153"  type="1"  ><li class="list__item" id="a261493d_154"><p>如果索引列是字符串，而条件输入参数是数字的话，那么索引列会发生隐式类型转换</p></li><li class="list__item" id="a261493d_155"><p>隐式类型转换是通过CAST函数实现，等同于对索引列使用函数</p></li></ol></li><li class="list__item" id="a261493d_156"><p>联合索引要能正确使用，需要遵循最左匹配原则，即按照最左优先的方式进行索引匹配，否则索引失效。</p></li><li class="list__item" id="a261493d_157"><p>where字句中，如果OR前面的条件列是索引列，但OR后的条件列不是索引列，那么索引会失效，全表扫描。</p></li></ol></section></section><section class="chapter"><h2 id="a261493d_158" data-toc="a261493d_158">语句</h2><section class="chapter"><h3 id="truncate-drop-delete" data-toc="truncate-drop-delete">truncate、drop、delete 对比</h3><ol class="list _decimal" id="a261493d_159"  type="1"  ><li class="list__item" id="a261493d_160"><p>truncate和drop是ddl语句，执行无法回滚；delete是dml语句，可以回滚</p></li><li class="list__item" id="a261493d_161"><p>truncate只能作用于表；delete和drop可以作用于表、视图等</p></li><li class="list__item" id="a261493d_162"><p>truncate会清空表内所有行，但保留表结构及其约束、索引等；drop会删除表结构及其约束索引等</p></li><li class="list__item" id="a261493d_163"><p>truncate会重置表的自增值；delete不会</p></li><li class="list__item" id="a261493d_164"><p>truncate不会激活触发器；delete会</p></li><li class="list__item" id="a261493d_165"><p>truncate后会使得表和索引占的空间释放恢复；delete不会；drop语句会将表占用空间全部释放</p></li></ol></section></section><section class="chapter"><h2 id="a261493d_166" data-toc="a261493d_166">案例</h2><section class="chapter"><h3 id="update-where" data-toc="update-where">一、线上执行update语句修改数据库时，where条件没有带上索引，导致业务直接崩了</h3><ol class="list _decimal" id="a261493d_167"  type="1"  ><li class="list__item" id="a261493d_168"><p>前提： </p><ol class="list _decimal" id="a261493d_169"  type="1"  ><li class="list__item" id="a261493d_170"><p>基于InnoDB存储引擎,隔离级别是可重复读</p></li></ol></li><li class="list__item" id="a261493d_171"><p>原因： </p><ol class="list _decimal" id="a261493d_172"  type="1"  ><li class="list__item" id="a261493d_173"><p>这种隔离级别下，多个事务并发时，会出现幻读问题，即同一个事务下，连续两次执行同个查询语句，第二次的查询可能会返回之前没有的行</p></li><li class="list__item" id="a261493d_174"><p>因此InnoDB存储引擎实现了行锁，通过next-key锁（记录锁和间隙锁的组合）来锁住记录本身和记录之间的间隙，防止其他事务在这个记录之间插入新的记录，从而避免了幻读现象</p></li><li class="list__item" id="a261493d_175"><p>执行update语句时，实际上会对记录加独占锁（X锁），如果其他线程修改该条记录会被阻塞，事务结束后释放（非update语句执行完）</p></li><li class="list__item" id="a261493d_176"><p>InnoDB事务中，对记录加锁的基本单位是next-key锁，但在一些条件下，会退化成间隙锁或记录锁。 </p><ol class="list _decimal" id="a261493d_177"  type="1"  ><li class="list__item" id="a261493d_178"><p>where条件加唯一索引</p></li><li class="list__item" id="a261493d_179"><p>如果where条件没有加锁，就会全表扫描，所有记录添加next-key锁，相当于锁表</p></li><li class="list__item" id="a261493d_180"><p>除了<code class="code" id="a261493d_181">select ... from</code> 语句，其他语句都会被锁住不能执行</p></li><li class="list__item" id="a261493d_182"><p>最终要看优化器选择的是索引扫描还是全表扫描，可以使用<code class="code" id="a261493d_183">force index([index name])</code></p></li></ol></li><li class="list__item" id="a261493d_184"><p>加锁的位置在索引上而非行上</p></li></ol></li><li class="list__item" id="a261493d_185"><p>解决： </p><ol class="list _decimal" id="a261493d_186"  type="1"  ><li class="list__item" id="a261493d_187"><p>sql_safe_update设置为1</p></li><li class="list__item" id="a261493d_188"><p>update语句需要满足如下条件之一才会执行成功 </p><ol class="list _decimal" id="a261493d_189"  type="1"  ><li class="list__item" id="a261493d_190"><p>使用where，且where条件必须带有索引列</p></li><li class="list__item" id="a261493d_191"><p>使用limit</p></li><li class="list__item" id="a261493d_192"><p>同时使用where和limit，此时where可以没有索引列</p></li></ol></li><li class="list__item" id="a261493d_193"><p>delete语句 </p><ol class="list _decimal" id="a261493d_194"  type="1"  ><li class="list__item" id="a261493d_195"><p>使用where，且where条件必须带有索引列</p></li><li class="list__item" id="a261493d_196"><p>同时使用where和limit，此时where可以没有索引列</p></li></ol></li></ol></li><li class="list__item" id="a261493d_197"><p><a href="https://mp.weixin.qq.com/s/9R8ChusahrJvLGmUvHWBgA" id="a261493d_198"   data-external="true" rel="noopener noreferrer" >链接</a></p></li></ol></section><section class="chapter"><h3 id="a261493d_199" data-toc="a261493d_199">二、如何实现跨库的联表查询</h3><ol class="list _decimal" id="a261493d_200"  type="1"  ><li class="list__item" id="a261493d_201"><p>在同一个服务器下的两个不同的逻辑数据库。表前面加数据库名即可</p></li></ol><div class="code-block" data-lang="sql"         >
 select * from orders o left join userdb.user u on o.uid = u.id
</div><ol class="list _decimal" id="a261493d_203"  type="1"  start="2"><li class="list__item" id="a261493d_204"><p id="a261493d_205">在不同的服务器下的不同数据库</p><ol class="list _decimal" id="a261493d_206"  type="1"  ><li class="list__item" id="a261493d_207"><p><code class="code" id="a261493d_208">show engines</code></p><ol class="list _decimal" id="a261493d_209"  type="1"  ><li class="list__item" id="a261493d_210"><p>添加 <code class="code" id="a261493d_211">federated</code></p></li><li class="list__item" id="a261493d_212"><p>需要 <code class="code" id="a261493d_213">federated YES</code></p></li></ol></li><li class="list__item" id="a261493d_214"><p>远程数据库表映射到本地数据库，类似oracle的dblink</p></li></ol><div class="code-block" data-lang="sql"         >
create table `orders` (
...
) ENGINE = FEDERATED AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
CONNECTION = 'mysql://root:123456@127.0.0.1:3306/orderdb/orders'
</div><ol class="list _decimal" id="a261493d_216"  type="1"  start="3"><li class="list__item" id="a261493d_217"><p>注意事项 </p><ol class="list _decimal" id="a261493d_218"  type="1"  ><li class="list__item" id="a261493d_219"><p>不推荐使用，老项目过渡可以</p></li><li class="list__item" id="a261493d_220"><p>本地表结构必须和远程完全一样</p></li><li class="list__item" id="a261493d_221"><p>远程数据库只支持连接MySQL</p></li><li class="list__item" id="a261493d_222"><p>不支持事务</p></li><li class="list__item" id="a261493d_223"><p>不支持表结构修改</p></li><li class="list__item" id="a261493d_224"><p>本地更新，远程表也会更新，反之亦然</p></li><li class="list__item" id="a261493d_225"><p>删除本地表。远程表不会删除</p></li></ol></li></ol></li></ol></section></section><section class="chapter"><h2 id="a261493d_227" data-toc="a261493d_227">函数</h2></section><section class="chapter"><h2 id="a261493d_228" data-toc="a261493d_228">字符串</h2><section class="chapter"><h3 id="a261493d_229" data-toc="a261493d_229">字符串截取</h3><ol class="list _decimal" id="a261493d_230"  type="1"  ><li class="list__item" id="a261493d_231"><p>SUBSTRING </p><ol class="list _decimal" id="a261493d_232"  type="1"  ><li class="list__item" id="a261493d_233"><p>SUBSTRING(s, start, length)</p></li><li class="list__item" id="a261493d_234"><p>从字符串s的start位置截取长度length的字符串</p></li></ol></li><li class="list__item" id="a261493d_235"><p>LEFT </p><ol class="list _decimal" id="a261493d_236"  type="1"  ><li class="list__item" id="a261493d_237"><p>LEFT(s,n)</p></li><li class="list__item" id="a261493d_238"><p>返回字符串s的后前个字符</p></li></ol></li><li class="list__item" id="a261493d_239"><p>RIGHT：同上</p></li><li class="list__item" id="a261493d_240"><p>MID： </p><ol class="list _decimal" id="a261493d_241"  type="1"  ><li class="list__item" id="a261493d_242"><p>MID(s, n, len)</p></li><li class="list__item" id="a261493d_243"><p>从字符串s的n位置截取长度为len的字符串</p></li><li class="list__item" id="a261493d_244"><p>同SUBSTRING(s, n, len)</p></li></ol></li></ol></section><section class="chapter"><h3 id="a261493d_245" data-toc="a261493d_245">聚合函数</h3><ol class="list _decimal" id="a261493d_246"  type="1"  ><li class="list__item" id="a261493d_247"><p>GROUP_CONCAT </p><ol class="list _decimal" id="a261493d_248"  type="1"  ><li class="list__item" id="a261493d_249"><p>GROUP_CONCAT([DISTINCT] field [order by field])</p></li><li class="list__item" id="a261493d_250"><p>字符串聚合函数，可去重，可加排序，与group by连用</p></li></ol></li></ol></section><section class="chapter"><h3 id="a261493d_251" data-toc="a261493d_251">其他</h3><ol class="list _decimal" id="a261493d_252"  type="1"  ><li class="list__item" id="a261493d_253"><p id="a261493d_254">RLIKE</p><ol class="list _decimal" id="a261493d_255"  type="1"  ><li class="list__item" id="a261493d_256"><p>RLIKE 'pattern'</p></li><li class="list__item" id="a261493d_257"><p>REGEXP执行字符串表达式模式匹配</p></li><li class="list__item" id="a261493d_258"><p>^ 开始、$ 结束、| 或者、</p></li></ol><div class="code-block" data-lang="sql"         >
select 
    * 
from 
    patients 
where 
    conditions rlike '^DIAB1|.*\\sDIAB1$'
</div></li></ol></section></section><div class="last-modified"> Last modified: 28 十一月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="pgfunction.html">常用函数列表</a>   <a class="navigation-links__next" href="explain.html">Explain</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>